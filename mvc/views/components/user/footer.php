<section class="ftco-section ftco-partner">
    <div class="container">
        <div class="row">
            <div class="col-sm ftco-animate">
                <a href="#" class="partner"><img src="<?php echo $base_url . $assets_url ?>images/partner-1.png" class="img-fluid" alt="Colorlib Template"></a>
            </div>
            <div class="col-sm ftco-animate">
                <a href="#" class="partner"><img src="<?php echo $base_url . $assets_url ?>images/partner-2.png" class="img-fluid" alt="Colorlib Template"></a>
            </div>
            <div class="col-sm ftco-animate">
                <a href="#" class="partner"><img src="<?php echo $base_url . $assets_url ?>images/partner-3.png" class="img-fluid" alt="Colorlib Template"></a>
            </div>
            <div class="col-sm ftco-animate">
                <a href="#" class="partner"><img src="<?php echo $base_url . $assets_url ?>images/partner-4.png" class="img-fluid" alt="Colorlib Template"></a>
            </div>
            <div class="col-sm ftco-animate">
                <a href="#" class="partner"><img src="<?php echo $base_url . $assets_url ?>images/partner-5.png" class="img-fluid" alt="Colorlib Template"></a>
            </div>
        </div>
    </div>
</section>

<section class="ftco-section ftco-no-pt ftco-no-pb py-5 bg-light">
    <div class="container py-4">
        <div class="row d-flex justify-content-center py-5">
            <div class="col-md-6">
                <h2 style="font-size: 22px;" class="mb-0">Đăng ký bản tin của chúng tôi</h2>
                <span>Nhận thông tin cập nhật qua e-mail về các cửa hàng mới nhất của chúng tôi và các ưu đãi đặc biệt</span>
            </div>
            <div class="col-md-6 d-flex align-items-center">
                <form action="#" class="subscribe-form">
                    <div class="form-group d-flex">
                        <input type="text" class="form-control" placeholder="Nhập địa chỉ email">
                        <input type="submit" value="Đăng ký" class="submit px-3">
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>
<footer class="ftco-footer ftco-section">
    <div class="container">
        <div class="row">
            <div class="mouse">
                <a href="#" class="mouse-icon">
                    <div class="mouse-wheel"><span class="ion-ios-arrow-up"></span></div>
                </a>
            </div>
        </div>
        <div class="row mb-5">
            <div class="col-md">
                <div class="ftco-footer-widget mb-4">
                    <h2 class="ftco-heading-2">GeenFoods</h2>
                    <p>Sản phẩm tươi ngon từ các trang trại đảm bảo chất lượng sản phẩm đạt chuẩn quốc tế</p>
                    <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
                        <li class="ftco-animate"><a href="#"><span class="icon-twitter"></span></a></li>
                        <li class="ftco-animate"><a href="#"><span class="icon-facebook"></span></a></li>
                        <li class="ftco-animate"><a href="#"><span class="icon-instagram"></span></a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md">
                <div class="ftco-footer-widget mb-4 ml-md-5">
                    <h2 class="ftco-heading-2">Menu</h2>
                    <ul class="list-unstyled">
                        <li><a href="#" class="py-2 d-block">Cửa hàng</a></li>
                        <li><a href="#" class="py-2 d-block">Giới thiệu</a></li>
                        <li><a href="#" class="py-2 d-block">Tạp chí</a></li>
                        <li><a href="#" class="py-2 d-block">Liên hệ với chúng tôi</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="ftco-footer-widget mb-4">
                    <h2 class="ftco-heading-2">Giúp đỡ</h2>
                    <div class="d-flex">
                        <ul class="list-unstyled mr-l-5 pr-l-3 mr-4">
                            <li><a href="#" class="py-2 d-block">Thông tin vận chuyển</a></li>
                            <li><a href="#" class="py-2 d-block">Trả lại &amp; Trao đổi </a></li>
                            <li><a href="#" class="py-2 d-block">Điều kiện &amp; Cá điều khoản khác</a></li>
                            <li><a href="#" class="py-2 d-block">Chính sách bảo mật</a></li>
                        </ul>
                        <ul class="list-unstyled">
                            <li><a href="#" class="py-2 d-block">FAQs</a></li>
                            <li><a href="#" class="py-2 d-block">Liên hệ</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md">
                <div class="ftco-footer-widget mb-4">
                    <h2 class="ftco-heading-2">Đặt câu hỏi </h2>
                    <div class="block-23 mb-3">
                        <ul>
                            <li><span class="icon icon-map-marker"></span><span class="text">50/50 Nguyễn Huệ TP Hồ Chí Minh</span></li>
                            <li><a href="#"><span class="icon icon-phone"></span><span class="text">+ 0965 123 465</span></a></li>
                            <li><a href="#"><span class="icon icon-envelope"></span><span class="text">GREENFOOD@EMAIL.COM</span></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
</footer>



<!-- loader -->
<!-- <div id="ftco-loader" class="show fullscreen">
    <svg class="circular" width="48px" height="48px">
        <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
        <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00" />
    </svg>
</div> -->


<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery-migrate-3.0.1.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>popper.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>bootstrap.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.easing.1.3.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.waypoints.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.stellar.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>owl.carousel.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.magnific-popup.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>aos.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>jquery.animateNumber.min.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>bootstrap-datepicker.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>scrollax.min.js?v=<?php echo time(); ?>"></script>
<!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script> -->
<!-- <script type="text/javascript" src="<php echo $main_js_url ?>google-map.js?v=<php echo time(); ?>"></script> -->
<script type="text/javascript" src="<?php echo $main_js_url ?>main.js?v=<?php echo time(); ?>"></script>
<script type="text/javascript" src="<?php echo $main_js_url ?>tata.js?v=<?php echo time(); ?>"></script>

<script type="text/javascript">
    $(document).ready(function() {
        $(".owl-carousel").owlCarousel({
            loop: true,
            margin: 30,
            dots: false,
            autoplay: true,
            autoplayTimeout: 1400,
            autoplayHoverPause: true,
            responsive: {
                0: {
                    items: 1
                },
                600: {
                    items: 2
                },
                1000: {
                    items: 4
                }
            }
        });
    });
</script>


<script>
    $(document).ready(function() {
        totalItem();
        const cartUrl = new URL("<?php echo $base_url . 'cart' ?>");
        const checkoutUrl = new URL("<?php echo $base_url . 'cart/checkout' ?>");

        if (window.location.href == cartUrl.toString()) {
            handleShowItemsInCart();
        } else if (window.location.href == checkoutUrl.toString()) {
            handleShowDetailOrder();
        }




    });

    let cart = [];
    const addToCart = async (data) => {
        let storage = localStorage.getItem('cart');
        if (storage) {
            console.log('storage exists');
        } else {
            console.log('storage is not found');
        }
        if (storage) {
            cart = JSON.parse(storage);
        }
        if (cart.length > 0 || cart.length != null) {
            let product = data;
            console.log("data.id=" + data.id);
            let item = cart.find(c => c.product.id == data.id);
            if (item) {
                item.quantity += 1;
            } else {
                cart.push({
                    product,
                    quantity: 1
                })
            }
            localStorage.setItem('cart', JSON.stringify(cart));

            //show toaster
            tata.success(`${data.foodName}`, `Add '${data.foodName}' successfully`, {
                position: 'tr'
            });
        }



        //update total item
        totalItem();


    }

    const totalItem = () => {
        let storage = localStorage.getItem('cart');
        const element = document.getElementById('totalItem');
        let totalQuantity = 0;
        if (storage) {
            cart = JSON.parse(storage);
            console.log("cart exist...");
            cart.map(item => {
                totalQuantity += item.quantity;
            });
            element.innerHTML = "<div id='item-cart'><span class='icon-shopping_cart'></span>[" + totalQuantity + "]</div>";
        } else {
            element.innerHTML = "<div id='item-cart'><span class='icon-shopping_cart'></span>[0]</div>";
        }


    }

    const handleShowItemsInCart = async () => {
        const cartContent = document.getElementById('cartContent');
        const productTable = document.getElementById('productTable');
        let storage = localStorage.getItem('cart');
        if (storage) {
            cart = JSON.parse(storage);
        }
        if (cart.length > 0) {
            let html = ``;
            await cart.map(item => {
                console.log("data" + item);
                const priceTotal = item.product.price * item.quantity;
                html += `
                    <tr class="text-center">
                        <td class="product-remove"><a href="javascript:void(0)" onclick="handleRemoveItemInCart(${item.product.id})"><span class="ion-ios-close"></span></a></td>

                        <td class="image-prod">
                            <div class="img" style="background-image:url(<?php echo $base_url . $assets_url ?>images/food/${item.product.foodImage});"></div>
                        </td>

                        <td class="product-name">
                            <h3>${item.product.foodName}</h3>
                            <p>${item.product.foodDescription.slice(0, 50)}...</p>
                        </td>

                        <td class="price">` + handleFormatMoney(parseInt(item.product.price)) + `</td>

                        <td class="quantity">
                            <div class="input-group mb-3">
                                <span class="input-group-btn mr-2">
                                    <button type="button" onclick="handleDescQuantity(${item.product.id})" class="quantity-left-minus" data-type="minus" data-field="">
                                        <em class="ion-ios-remove"></em>
                                    </button>
                                </span>
                                <input type="text" id="quantity-${item.product.id}" name="quantity" class="form-control input-number" value="${item.quantity}" min="1" max="100">
                                <span class="input-group-btn ml-2">

                                    <button type="button" onclick="handleIncQuantity(${item.product.id})" class="quantity-right-plus" data-type="plus" data-field="">
                                        <em class="ion-ios-add"></em>
                                    </button>
                                </span>
                                
                            </div>
                        </td>

                        <td class="total">` + handleFormatMoney(priceTotal) + `</td>
                    </tr>
                `;
            });
            const removeAllButton = `<tr class="text-center">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><a class="btn btn-danger rounded text-white" onclick="handleRemoveAll()">Remove All</a></td>
                </tr>`;
            productTable.innerHTML = html + removeAllButton;
            handleUpdateOrder();
        } else {
            renderEmptyCart();
        }
    }
    const renderEmptyCart = () => {
        const cartContent = document.getElementById('cartContent');
        document.getElementById('cartRow').remove();
        document.getElementById('cartBill').remove();
        cartContent.innerHTML = `<?php require "./mvc/views/components/user/empty-cart.php"; ?>`;
    }

    const handleRemoveItemInCart = async (id) => {
        let storage = localStorage.getItem('cart');
        if (storage) {
            cart = JSON.parse(storage);
        }
        if (cart.length > 0) {
            //show toaster
            let item = cart.find(c => c.product.id == id);
            tata.warn(`Warning!`, `Delele '${item.product.foodName}' successfully`, {
                position: 'tr'
            });

            cart = await cart.filter(item => item.product.id != id);
            localStorage.setItem('cart', JSON.stringify(cart));

            handleShowItemsInCart();
            handleUpdateOrder();
            totalItem();
        } else {
            renderEmptyCart();
        }

    }

    const handleRemoveAll = () => {
        const swalWithBootstrapButtons = Swal.mixin({
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
            title: 'Are you sure?',
            text: "You will not be able to recover this cart!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, cancel!',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.removeItem('cart');
                renderEmptyCart();
                totalItem();
                swalWithBootstrapButtons.fire(
                    'Deleted!',
                    'Your product has been deleted.',
                    'success'
                )
            } else if (
                /* Read more about handling dismissals below */
                result.dismiss === Swal.DismissReason.cancel
            ) {
                swalWithBootstrapButtons.fire(
                    'Cancelled',
                    'Your product is safe :)',
                    'error'
                )
            }
        })

    }
</script>
<script type="text/javascript">
    $(document).ready(function() {

        var quantitiy = 0;
        $('.quantity-right-plus').click(function(e) {

            // Stop acting like a button
            e.preventDefault();
            // Get the field name
            var quantity = parseInt($('#quantity').val());

            // If is not undefined

            $('#quantity').val(quantity + 1);


            // Increment

        });

        $('.quantity-left-minus').click(function(e) {
            // Stop acting like a button
            e.preventDefault();
            // Get the field name
            var quantity = parseInt($('#quantity').val());

            // If is not undefined

            // Increment
            if (quantity > 1) {
                $('#quantity').val(quantity - 1);
            }
        });



    });

    function handleIncQuantity(id) {
        var quantity = parseInt($('#quantity-' + id).val());

        // If is not undefined

        $('#quantity-' + id).val(quantity + 1);

        // Increment

        updateQuantity(id);
        handleUpdateOrder();
    }

    function handleDescQuantity(id) {
        var quantity = parseInt($('#quantity-' + id).val());

        // If is not undefined

        // descrement
        if (quantity > 1) {
            $('#quantity-' + id).val(quantity - 1);
        }

        updateQuantity(id);
        handleUpdateOrder();
    }

    function updateQuantity(id) {
        let storage = localStorage.getItem('cart');
        cart = JSON.parse(storage);
        for (var i = 0; i < cart.length; ++i) {
            if (cart[i]['product']['id'] == id) {
                cart[i]['quantity'] = parseInt($('#quantity-' + id).val());
            }
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        handleShowItemsInCart();
        totalItem();
    }
</script>
<!-- Cart Total -->
<script>
    const handleUpdateOrder = () => {
        let storage = localStorage.getItem('cart');
        if (storage) {
            cart = JSON.parse(storage);
        }
        let moneyTotal = 0;
        if (cart.length > 0) {
            cart.map(item => {
                moneyTotal += item.product.price * item.quantity;
            });
        }
        handleRenderCartTotal(moneyTotal);

    }
    const handleFormatMoney = (money) => {
        return money.toLocaleString('it-IT', {
            style: 'currency',
            currency: 'VND'
        });
    }

    const handleRenderCartTotal = (money) => {
        const cartTotal = document.getElementById('cart-total');
        cartTotal.innerHTML = `
            <div class='cart-total mb-3'>
                <h3>Cart Totals</h3>
                <p class='d-flex'>
                    <span>Subtotal</span>
                    <span>` + handleFormatMoney(money) + `</span>
                </p>
                <p class='d-flex'>
                    <span>Delivery</span>
                    <span>0</span>
                </p>
                <p class='d-flex'>
                    <span>Discount</span>
                    <span>0</span>
                </p>
                <hr>
                <p class='d-flex total-price'>
                    <span>Total</span>
                    <span>` + handleFormatMoney(money) + `</span>
                </p>
            </div>
            <p><a href="<?php echo $base_url . 'cart/checkout' ?>" class='btn btn-primary py-3 px-4'>Proceed to Checkout</a></p>
        `;
    }
    const handleShowDetailOrder = () => {
        let storage = localStorage.getItem('cart');
        if (storage) {
            cart = JSON.parse(storage);
        }
        let moneyTotal = 0;
        if (cart.length > 0) {
            cart.map(item => {
                moneyTotal += item.product.price * item.quantity;
            });
        }
        const cartTotal = document.getElementById('cart-total');
        cartTotal.innerHTML = `
            <div class="cart-detail cart-total p-3 p-md-4">
                <h3 class="billing-heading mb-4">Cart Total</h3>
                <p class="d-flex">
                    <span>Subtotal</span>
                    <span>` + handleFormatMoney(moneyTotal) + `</span>
                </p>
                <p class="d-flex">
                    <span>Delivery</span>
                    <span>0</span>
                </p>
                <p class="d-flex">
                    <span>Discount</span>
                    <span>0</span>
                </p>
                <hr>
                <p class="d-flex total-price">
                    <span>Total</span>
                    <span>` + handleFormatMoney(moneyTotal) + `</span>
                </p>
            </div>
        `;
    }

    const handlePayment = () => {
        //payment method
        let paymentMethod = 'home';
        const radio = $("input[type=radio][name=pay_radio]").filter(":checked")[0];
        if (radio) {
            paymentMethod = radio.value;
        }

        //buyer information
        const firstname = document.getElementById('firstname').value;
        const lastname = document.getElementById('lastname').value;
        const country = document.getElementById('country').value;
        const city = document.getElementById('city').value;
        const address = document.getElementById('address').value;
        const phone = document.getElementById('phone').value;
        const email = document.getElementById('email').value;

        //order detail
        let storage = localStorage.getItem('cart');
        if (storage) {
            cart = JSON.parse(storage);
        }
        let moneyTotal = 0;
        const orderId = <?php echo date("YmdHis") ?>;
        console.log(" orderId first: " + orderId);
        const orderDecription = {
            'moneyTotal': 0,
            'orderId': orderId,
            'data': [],
            'buyer': {
                'firstname': firstname,
                'lastname': lastname,
                'country': country,
                'city': city,
                'address': address,
                'phone': phone,
                'email': email
            },
            'paymentMethod': paymentMethod
        };
        if (cart.length > 0) {
            cart.map(item => {
                moneyTotal += item.product.price * item.quantity;
                orderDecription.moneyTotal = moneyTotal;
                orderDecription.data.push(item);

            });
        }
        //call ajax
        $.ajax({
            type: "POST",
            url: "<?php echo $base_url ?>cart/handleSaveOrder",
            data: {
                order: orderDecription
            },
            cache: false,
            success: function(data) {
                const result = JSON.parse(data);
                if (result.status_code == 200) {
                    console.log(" orderId: " + orderId);
                    if (paymentMethod == 'home') {
                        window.location.href = "<?php echo $base_url ?>" + "mvc/vnpay/vnpay_return.php?payAtHome=true";
                    } else {
                        $.ajax({
                            type: "POST",
                            url: "<?php echo $base_url ?>" + "mvc/vnpay/vnpay_create_payment.php",
                            data: {
                                desc: result.desc, //not use
                                order: orderDecription
                            },
                            cache: false,
                            success: function(data) {
                                const res = JSON.parse(data);
                                window.location.href = res.data;
                            }
                        });
                    }

                }

            }
        });

    }
</script>